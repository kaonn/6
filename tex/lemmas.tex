

\begin{definition}(Types and Equality)
  Given a type system $\tau$, 
  \begin{enumerate}
    \item \eqType{A}{B} when \sameType{A}{B}{\alpha}{\tau} for some $\alpha$.
    \item \eqCComp{M}{M'}{A}{P}{a.Q} when presupposing \eqType{A}{A},
      \sameType{A}{A}{\alpha}{\tau} and \sameCComp{}{M}{M'}{\alpha}{P}{a.Q} 
      for some $\alpha$.
    \item \eqVal{v}{v'}{A} when presupposing \eqType{A}{A},
      \sameType{A}{A}{\alpha}{\tau} and $\alpha(v,v')$ for some $\alpha$.
  \end{enumerate}
\end{definition}

\begin{definition}(Context)
  \eqCtx{\Gamma}{\Gamma'} when
  \begin{enumerate}
    \item \eqCtx{\cdot}{\cdot}
    \item \eqCtx{\isOf{a}{A},\Gamma}{\isOf{a}{A'},\Gamma'} when \eqType{A}{A'} and for all 
      \eqVal{v}{v'}{A}, \eqCtx{[v/a]\Gamma}{[v'/a]\Gamma'}
  \end{enumerate}
\end{definition}

\begin{definition}(Substitution)
  \eqInst{\gamma}{\gamma'}{\Gamma} when
  \begin{enumerate}
    \item \eqInst{\cdot}{\cdot}{\cdot}
    \item \eqInst{v,\gamma}{v',\gamma'}{\isOf{a}{A},\Gamma} when
      \eqVal{v}{v'}{A}, \eqInst{\gamma}{\gamma'}{[v/a]\Gamma}
  \end{enumerate}
\end{definition}

\begin{definition}(Open Judgments)
  \begin{enumerate}
    \item \openEqTypeComp{\Gamma}{A}{A'} when for all \eqInst{\gamma}{\gamma'}{\Gamma}, 
      \eqType{\gamma A}{\gamma A'}
    \item \openEqComp{\Gamma}{M}{M'}{A} when for all \eqInst{\gamma}{\gamma'}{\Gamma}, 
      \eqComp{\gamma M}{\gamma M'}{\gamma A}
    \item \openEqVal{\Gamma}{v}{v'}{A} when for all \eqInst{\gamma}{\gamma'}{\Gamma}, 
      \eqVal{\gamma v}{\gamma v'}{\gamma A}
  \end{enumerate}
\end{definition}

\begin{lemma}(Sequence)
  If \isComp{M_1}{A_1} and \openComp{\isOf{x}{A_1}}{M_2}{A_2}, then 
  \isComp{\seq{\thunk{M_1}}{x}{M_2}}{\seq{\thunk{M_1}}{x}{A_2}}.
\end{lemma}

\begin{proof}
  First, we need to show \eqType{\seq{\thunk{M_1}}{x}{A_2}}{\seq{\thunk{M_1}}{x}{A_2}}.
  By definition, STS \sameType{\seq{\thunk{M_1}}{x}{A_2}}{\seq{\thunk{M_1}}{x}{A_2}}{\alpha}{\tau} for some $\alpha$. 
  By assumption, we know \sameType{A_1}{A_1}{\alpha_1}{\tau} for some $\alpha_1$ and 
  that \eval{M_1}{v_1} and $\alpha_1(v_1,v_1)$. Hence $\eqVal{v_1}{v_1}{A_1}$.
  By definition, \eqInst{(v_1,\cdot)}{(v_1,\cdot)}{(\isOf{x}{A_1},\cdot)}.
  The second assumption gives \openEqTypeComp{\isOf{x}{A_1}}{A_2}{A_2}. 
  Applying the definition with the above instance gives 
  \eqType{[v_1/x]A_2}{[v_1/x]A_2}. This means \sameType{[v_1/x]A_2}{[v_1/x]A_2}{\alpha}{\tau}
  for some $\alpha$. Since
  \stepIn{\seq{\thunk{M_1}}{x}{A_2}}{*}{[v_1/x]A_2}, we are done.

  Next, we need to show \isComp{\seq{\thunk{M_1}}{x}{M_2}}{\seq{\thunk{M_1}}{x}{A_2}}.
  STS \sameComp{}{\seq{\thunk{M_1}}{x}{M_2}}{\seq{\thunk{M_1}}{x}{A_2}}{\alpha} for the $\alpha$
  above. By similar reasoning, we have \eqComp{[v_1/x]M_2}{[v_1/x]M_2}{[v_1/x]A_2}.
  This implies $\sameComp{}{[v_1/x]M_2}{[v_1/x]M_2}{\alpha}$.
  Since \stepIn{\seq{\thunk{M_1}}{x}{M_2}}{*}{[v_1/x]M_2}, we are done.
\end{proof}

\begin{lemma}(Nat Formation)
  \eqType{\nat}{\nat}.
\end{lemma}

\begin{lemma}(Nat Introduction)
  \begin{enumerate}
    \item \eqVal{\zero}{\zero}{\nat}. 
    \item \eqVal{\suc{n}}{\suc{n'}}{\nat} given \eqVal{n}{n'}{\nat}.
  \end{enumerate}
\end{lemma}

\begin{lemma}(Comp Formation)
  Given \eqType{A}{A'}, \eqComp{P}{P'}{\nat}, \openEqComp{\isOf{a}{A}}{Q}{Q'}{\nat}, then
  \eqType{\ccomp{P}{\isOf{a}{A}}{Q}}{\ccomp{P'}{\isOf{a}{A'}}{Q'}}.
\end{lemma}

\begin{lemma}(Comp Introduction)
  Given \eqComp{M}{M'}{A}, 
  \eqVal{\thunk{M}}{\thunk{M'}}{\ccomp{P}{\isOf{a}{A}}{Q}} when 
  \evalCost{M}{c}{v}, \evalCost{M'}{c'}{v'}, \eval{P}{\bar{p}}, 
  \eval{[v/a]Q}{\bar{q}}, \eval{[v'/a]Q}{\bar{q'}}, and 
  $p \ge c + q$ and $p \ge c' + q'$.
\end{lemma}

\begin{proof}
  Suppose \eqComp{M}{M'}{A} and 
  \evalCost{M}{c}{v}, \evalCost{M'}{c'}{v'}, \eval{P}{\bar{p}}, 
  \eval{[v/a]Q}{\bar{q}}, \eval{[v'/a]Q}{\bar{q'}}, and 
  $p \ge c + q$ and $p \ge c' + q'$.
  By definition, $\tau(\ccomp{P}{\isOf{a}{A}}{Q}, \ccomp{P}{\isOf{a}{A}}{Q}, \phi)$, and 
  the above conditions suffice for $\phi(\thunk{M},\thunk{M'})$. Hence 
  \eqVal{\thunk{M}}{\thunk{M'}}{\ccomp{P}{\isOf{a}{A}}{Q}}.
\end{proof}

\begin{lemma}(Promise)
  If \isVal{u}{\ccomp{P}{\isOf{a}{A}}{Q}}, 
  then $u$ is $\thunk{M}$ for some $M$ s.t. \eqComp{M}{M}{A}, \evalCost{M}{c}{v},
  \eval{P}{\bar{p}}, \eval{[v/a]Q}{\bar{q}}
  s.t. $p \ge c + q$.
\end{lemma}

\begin{proof}
  By assumption, $\tau(\ccomp{P}{\isOf{a}{A}}{Q}, \ccomp{P}{\isOf{a}{A}}{Q}, \phi)$ and 
  $\phi(u,u)$ for some $\phi$. The result follows from the definition of $\phi$.
\end{proof}

\begin{lemma}(Head Expansion)\label{lemma:headexp}
  \begin{enumerate}
    \item \isTypeComp{A} and \stepIn{A}{*}{A'} implies \eqType{A}{A'}.
    \item \isComp{M'}{A} and \stepIn{M}{*}{M'} implies \eqComp{M}{M'}{A}.
  \end{enumerate}
\end{lemma}

\begin{proof} \ 
  \begin{enumerate}
    \item Suppose \isTypeComp{A} and \stepIn{A}{*}{A'}. This means 
      \sameType{A}{A}{\alpha}{\tau} for some $\alpha$, which means 
      \eval{A}{A_0} and $\tau(A_0,A_0,\tau)$. Since $\Downarrow$ deterministic, 
      \eval{A'}{A_0}, and hence also \sameType{A}{A'}{\alpha}{\tau}. By definition,
      \eqType{A}{A'}.
    \item Suppose \isComp{M'}{A} and \stepIn{M}{*}{M'}. This means 
      \sameType{A}{A}{\alpha}{\tau} and \sameComp{}{M'}{M'}{\alpha} for some $\alpha$.
      This means \eval{M'}{v'} and $\alpha(v',v')$. Again, since $\Downarrow$ is 
      deterministic, \eval{M}{v'} and \sameComp{}{M}{M'}{\alpha}. Thus 
      \eqComp{M}{M'}{A}.
  \end{enumerate}
\end{proof}

\iffalse
\begin{lemma}(Recursor)
  Given 
  \begin{gather*}
    \isVal{n}{\ret{\nat}}\\
    \openTypeComp{\isOf{x}{\ret{\nat}}}{B}\\
    \isComp{M_0}{[\zero/x]B}\\
    \openComp{\isOf{z}{\ret{\nat}}, \isOf{f}{\ret{\ccomp{\zp}{[z/x]B}{\zp}}}}{M_1}{[\suc{z}/x]B}\\
    \isComp{P_0}{\ret{\nat}}\\
    \openComp{\isOf{z}{\ret{\nat}}}{P_1}{\ret{\nat}}\\
    \isComp{Q_0}{\ret{\nat}}\\
    \openComp{\isOf{z}{\ret{\nat}}}{Q_1}{\ret{\nat}}\\
    \evalCost{M_0}{c_0}{v_0}, \eval{P_0}{\bar{p_0}}, \eval{Q_0}{\bar{q_0}}, 
    p_0 \ge c_0 + q_0\\
    \forall \isVal{z}{\ret{\nat}}, \isVal{f}{\ret{\ccomp{\zp}{[z/x]B}{\zp}}}.\,
    \evalCost{M_1}{c_1}{v_1}, \eval{P_1}{\bar{p_1}}, \eval{Q_1}{\bar{q_1}},
    p_1 \ge c_1 + q_1
  \end{gather*}
  Then 
  \begin{gather*}
  \evalCost{\rec{n}{M_0}{z}{f}{M_1}}{c}{v},\\
    \eval{\rec{n}{P_0^+}{z}{g}{\bind{P_1}{p_1}{\seq{g}{r}{\plus\;p_1\;r}}}^+}{\bar{p}},\\
    \eval{\rec{n}{Q_0^+}{z}{g}{\bind{Q_1}{q_1}{\seq{g}{r}{\plus\;q_1\;r}}}^+}{\bar{q}}, 
  \end{gather*}
  and $p \ge c + q$.
\end{lemma}

\begin{proof}
  Induction on $n$.
  \begin{itemize}
    \item $n = \zero$:
      \begin{align*}
        &\rec{\zero}{M_0}{z}{f}{M_1}\\
        \mapsto& M_0\\
        \mapsto^{c_0}& \ret{v_0}\\
      \end{align*}
      Further,
  \eval{\rec{\zero}{P_0^+}{z}{g}{\bind{P_1}{p_1}{\seq{g}{r}{\plus\;p_1\;r}}}^+}{\overline{p_0+1}},
      \eval{\rec{\zero}{Q_0^+}{z}{g}{\bind{Q_1}{q_1}{\seq{g}{r}{\plus\;q_1\;r}}}^+}{\overline{q_0+1}}, 
      
  and the result holds since $p_0 \ge c_0 + q_0$.
\item $n = \suc{n'}$ for \isVal{n'}{\ret{\nat}}:\\
  Then \step{\rec{\suc{n'}}{M_0}{z}{f}{M_1}}{[n'/z, \thunk{\rec{n'}{M_0}{z}{f}{M_1}}/f]M_1}.
  By induction: 
  \begin{gather*}
  \evalCost{\rec{n'}{M_0}{z}{f}{M_1}}{c'}{v'},\\
    \eval{\rec{n'}{P_0^+}{z}{g}{\bind{P_1}{p_1}{\seq{g}{r}{\plus\;p_1\;r}}}^+}{\bar{p'}},\\
    \eval{\rec{n'}{Q_0^+}{z}{g}{\bind{Q_1}{q_1}{\seq{g}{r}{\plus\;q_1\;r}}}^+}{\bar{q'}}, 
  \end{gather*}
      and $p' \ge c' + q'$.
  \end{itemize}
\end{proof}
\fi
